<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN - Tetapan Yuran Sekolah</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f0f0; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #d32f2f; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-top: 0; font-size: 1.8rem; }
        .control-panel { background: #fff5f5; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #ffcdd2; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
        input, select { padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        /* Style Section */
        .extra-section { background-color: #e3f2fd; padding: 15px; border-radius: 6px; margin-top: 10px; border: 1px dashed #2196F3; display: none; }
        .variant-section { background-color: #fff3e0; padding: 15px; border-radius: 6px; margin-top: 10px; border: 1px dashed #ff9800; display: none; }

        .btn-quick-tag { background-color: #fff; border: 1px solid #2196F3; color: #1976D2; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; cursor: pointer; margin: 3px; transition: all 0.2s; display: inline-block; }
        .btn-quick-tag:hover { background-color: #bbdefb; transform: translateY(-1px); }
        
        .sub-item-list { margin-top: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 10px; min-height: 40px; }
        .sub-item-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 5px 10px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9rem; border-bottom: 1px solid #eee; }
        
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; font-size: 0.95rem; }
        button:hover { opacity: 0.9; }
        .btn-add { background: #2E7D32; color: white; flex: 2; }
        .btn-update { background: #E65100; color: white; flex: 2; }
        .btn-cancel { background: #78909c; color: white; flex: 1; display: none; }
        .btn-save { background: #1565C0; color: white; font-size: 1.1rem; width: 100%; margin-top: 30px; padding: 15px; }
        .btn-delete { background: #d32f2f; color: white; padding: 6px 12px; font-size: 0.85rem; margin-left: 5px;}
        .btn-edit { background: #F57C00; color: white; padding: 6px 12px; font-size: 0.85rem; }
        .btn-add-sub { background: #0288d1; color: white; padding: 8px 15px; width: 100%; margin-top: 10px; }
        .btn-add-var { background: #ff9800; color: white; padding: 8px 15px; width: 100%; margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #f9fafb; font-weight: 600; color: #444; }
        .tag-wajib { color: #c62828; background: #ffebee; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .tag-pilihan { color: #2e7d32; background: #e8f5e9; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .detail-list { font-size: 0.85rem; color: #555; margin-top: 5px; padding-left: 10px; border-left: 3px solid #ccc; }
        .reservation-badge { background-color: #e0f2fe; color: #0284c7; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; border: 1px solid #bae6fd; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ADMIN: Pengurusan Senarai Yuran</h1>
        <p style="color:#666; margin-bottom:20px;">Uruskan senarai yuran, buku latihan, dan varian harga di sini.</p>

        <div class="control-panel">
            <div class="form-group">
                <label>1. Pilih Kategori:</label>
                <select id="admin-grade" onchange="handleGradeChange()">
                    <option value="pra">Prasekolah</option>
                    <option value="tahap1">Tahap 1 (Tahun 1, 2, 3)</option>
                    <option value="tahap2">Tahap 2 (Tahun 4, 5, 6)</option>
                </select>
            </div>

            <div class="form-group" style="border-top:1px solid #ffcdd2; padding-top:20px;">
                <label id="form-title">2. Item Utama:</label>
                <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <div style="flex: 2; min-width: 200px;">
                        <input type="text" id="new-name" placeholder="Nama Item (cth: Baju T-Sekolah)">
                    </div>
                    <div style="flex: 1; min-width: 100px;">
                        <input type="number" id="new-price" placeholder="Harga (RM)" step="0.01">
                        <small style="font-size:0.7rem; color:#888;">*Biarkan 0 jika ada varian harga</small>
                    </div>
                    <div style="flex: 1; min-width: 100px;">
                        <select id="new-required">
                            <option value="true">Wajib</option>
                            <option value="false">Pilihan</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; display:flex; flex-direction:column; gap:8px;">
                    <label style="display:inline-flex; align-items:center; cursor:pointer; color:#0284c7; font-weight:bold;">
                        <input type="checkbox" id="new-allow-reservation" style="width:auto; margin-right:8px;">
                        üõçÔ∏è Item ini boleh ditempah? (Ada butang 'Beli di Kaunter')
                    </label>
                    <label style="display:inline-flex; align-items:center; cursor:pointer; color:#e65100; font-weight:bold; background-color:#fff3e0; padding:5px; border-radius:4px;">
                        <input type="checkbox" id="is-variant-set" onchange="toggleSections()" style="width:auto; margin-right:8px;">
                        üîÄ Item ini ada pilihan harga? (cth: Lengan Pendek/Panjang)
                    </label>
                    <label style="display:inline-flex; align-items:center; cursor:pointer; color:#1565C0; font-weight:bold; background-color:#e3f2fd; padding:5px; border-radius:4px;">
                        <input type="checkbox" id="is-book-set" onchange="toggleSections()" style="width:auto; margin-right:8px;">
                        üìö Item ini ada senarai buku di dalamnya?
                    </label>
                </div>

                <!-- Section VARIAN (Baju dll) -->
                <div id="variant-section" class="variant-section">
                    <label style="font-size:0.9rem; font-weight:bold; color:#e65100;">3. Masukkan Pilihan Varian:</label>
                    <div style="display:flex; gap:5px; align-items:flex-end;">
                        <div style="flex:3;">
                            <small>Nama Pilihan</small>
                            <input type="text" id="var-name" placeholder="cth: Lengan Pendek">
                        </div>
                        <div style="flex:1;">
                            <small>Harga (RM)</small>
                            <input type="number" id="var-price" placeholder="35.00">
                        </div>
                    </div>
                    <button class="btn-add-var" onclick="addVariant()">+ Tambah Pilihan</button>
                    <div id="temp-var-list" class="sub-item-list"><small style="color:#999;">Tiada pilihan ditambah.</small></div>
                </div>

                <!-- Section BUKU -->
                <div id="book-section" class="extra-section">
                    <label style="font-size:0.9rem; font-weight:bold; color:#1976D2;">3. Masukkan Jenis Buku:</label>
                    <div style="margin-bottom: 10px; margin-top:5px;">
                        <button class="btn-quick-tag" onclick="fillSubBook('Buku Garis Satu')">Garis 1</button>
                        <button class="btn-quick-tag" onclick="fillSubBook('Buku Garis Tiga')">Garis 3</button>
                        <button class="btn-quick-tag" onclick="fillSubBook('Buku Petak Kecil')">Petak Kecil</button>
                        <button class="btn-quick-tag" onclick="fillSubBook('Buku Petak Sederhana')">Petak Sederhana</button>
                    </div>
                    <div style="display:flex; gap:5px; align-items:flex-end;">
                        <div style="flex:3;"><small>Jenis Buku</small><input type="text" id="sub-book-name"></div>
                        <div style="flex:1;"><small>Bil</small><input type="number" id="sub-book-qty" value="1"></div>
                        <div style="flex:1;"><small>Muka Surat</small><input type="number" id="sub-book-pages" value="80"></div>
                    </div>
                    <button class="btn-add-sub" onclick="addSubBook()">+ Tambah Buku</button>
                    <div id="temp-sub-list" class="sub-item-list"><small style="color:#999;">Tiada buku ditambah.</small></div>
                </div>

                <div style="margin-top: 15px;">
                    <input type="text" id="new-note" placeholder="Nota Tambahan (Pilihan)">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button id="btn-submit" class="btn-add" onclick="processForm()">+ Tambah Item Ke Jadual</button>
                    <button id="btn-cancel" class="btn-cancel" onclick="cancelEdit()">Batal</button>
                </div>
            </div>
        </div>

        <h3>Senarai Semasa: <span id="current-cat-display" style="color:#1565C0;">...</span></h3>
        <table>
            <thead>
                <tr>
                    <th style="width: 50%;">Item & Perincian</th>
                    <th style="width: 15%;">Jenis</th>
                    <th style="width: 15%;">Harga</th>
                    <th style="width: 20%;">Tindakan</th>
                </tr>
            </thead>
            <tbody id="admin-list-body"></tbody>
        </table>

        <button class="btn-save" onclick="saveToStorage()">üíæ SIMPAN PERUBAHAN</button>
    </div>

    <script>
        const commonFees = [
            { name: "Sumbangan PIBG", price: 30.00, required: true, note: "Satu keluarga sahaja. Dana untuk program sekolah.", allowReservation: false },
            { name: "Sumbangan Keceriaan Kelas", price: 10.00, required: true, note: "Setiap murid. Untuk alas meja, langsir, cat.", allowReservation: false },
            { 
                name: "Baju T-Sekolah", 
                price: 0, 
                required: false, 
                note: "Sila pilih jenis lengan", 
                allowReservation: false,
                variants: [
                    { name: "Lengan Pendek", price: 35.00 },
                    { name: "Lengan Panjang", price: 40.00 }
                ]
            },
            { name: "Name Tag (1 set 3 keping)", price: 5.00, required: false, note: "Pilihan", allowReservation: false },
            { name: "Buku & Alat Tulis", price: 0.00, required: false, note: "Ada jualan kedai luar.", allowReservation: true }
        ];

        const defaultData = {
            "pra": JSON.parse(JSON.stringify(commonFees)),
            "tahap1": JSON.parse(JSON.stringify(commonFees)),
            "tahap2": JSON.parse(JSON.stringify(commonFees))
        };

        let currentData = {};
        let tempBookList = []; 
        let tempVariantList = [];
        let editMode = false;
        let editIndex = null;

        function init() {
            const stored = localStorage.getItem('schoolFeesData');
            currentData = stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(defaultData));
            renderAdminList();
        }

        function handleGradeChange() { cancelEdit(); renderAdminList(); }

        function toggleSections() {
            document.getElementById('book-section').style.display = document.getElementById('is-book-set').checked ? 'block' : 'none';
            document.getElementById('variant-section').style.display = document.getElementById('is-variant-set').checked ? 'block' : 'none';
        }

        // --- VARIANT LOGIC ---
        function addVariant() {
            const name = document.getElementById('var-name').value;
            const price = parseFloat(document.getElementById('var-price').value);
            if(!name || isNaN(price)) return alert("Isi nama dan harga varian.");
            tempVariantList.push({ name, price });
            renderTempVariants();
            document.getElementById('var-name').value = '';
            document.getElementById('var-price').value = '';
        }
        function removeVariant(idx) { tempVariantList.splice(idx, 1); renderTempVariants(); }
        function renderTempVariants() {
            const container = document.getElementById('temp-var-list');
            if(tempVariantList.length === 0) { container.innerHTML = '<small style="color:#999;">Tiada pilihan.</small>'; return; }
            container.innerHTML = '';
            tempVariantList.forEach((v, idx) => {
                container.innerHTML += `<div class="sub-item-row"><span>üîò ${v.name} - RM${v.price.toFixed(2)}</span><button onclick="removeVariant(${idx})" style="color:red;background:none;border:none;">‚úï</button></div>`;
            });
        }

        // --- BOOK LOGIC ---
        function fillSubBook(name) { document.getElementById('sub-book-name').value = name; }
        function addSubBook() {
            const name = document.getElementById('sub-book-name').value;
            const qty = document.getElementById('sub-book-qty').value;
            const pages = document.getElementById('sub-book-pages').value;
            if(!name) return alert("Isi nama buku.");
            tempBookList.push({ name, qty, pages });
            renderTempBooks();
            document.getElementById('sub-book-name').value = '';
        }
        function removeSubBook(idx) { tempBookList.splice(idx, 1); renderTempBooks(); }
        function renderTempBooks() {
            const container = document.getElementById('temp-sub-list');
            if(tempBookList.length === 0) { container.innerHTML = '<small style="color:#999;">Tiada buku.</small>'; return; }
            container.innerHTML = '';
            tempBookList.forEach((b, idx) => {
                container.innerHTML += `<div class="sub-item-row"><span>üìö ${b.name} (${b.qty}x)</span><button onclick="removeSubBook(${idx})" style="color:red;background:none;border:none;">‚úï</button></div>`;
            });
        }

        function renderAdminList() {
            const grade = document.getElementById('admin-grade').value;
            const tbody = document.getElementById('admin-list-body');
            document.getElementById('current-cat-display').innerText = grade.toUpperCase();
            tbody.innerHTML = '';

            if (currentData[grade]) {
                // Sort: Wajib first
                currentData[grade].sort((a, b) => (a.required === b.required) ? 0 : a.required ? -1 : 1);

                currentData[grade].forEach((item, index) => {
                    const tr = document.createElement('tr');
                    const priceDisplay = item.price === 0 && (!item.variants || item.variants.length===0) ? "Ikut Belian" : (item.variants && item.variants.length > 0 ? "Ikut Pilihan" : `RM ${parseFloat(item.price).toFixed(2)}`);
                    const tagText = item.required ? 'WAJIB' : 'PILIHAN';
                    const tagClass = item.required ? 'tag-wajib' : 'tag-pilihan';
                    
                    let detailsHtml = `<strong>${item.name}</strong>`;
                    if (item.allowReservation) detailsHtml += `<span class="reservation-badge">üõçÔ∏è Boleh Tempah</span>`;
                    
                    if (item.variants && item.variants.length > 0) {
                        detailsHtml += `<ul class="detail-list" style="border-left-color:#ff9800;">`;
                        item.variants.forEach(v => detailsHtml += `<li>üîò ${v.name} (RM${v.price.toFixed(2)})</li>`);
                        detailsHtml += `</ul>`;
                    }
                    if (item.bookList && item.bookList.length > 0) {
                        detailsHtml += `<ul class="detail-list" style="border-left-color:#2196F3;">`;
                        item.bookList.forEach(b => detailsHtml += `<li>üìö ${b.name}</li>`);
                        detailsHtml += `</ul>`;
                    }
                    if (item.note) detailsHtml += `<br><small style="color:#666;">${item.note}</small>`;

                    tr.innerHTML = `<td>${detailsHtml}</td><td><span class="${tagClass}">${tagText}</span></td><td style="font-weight:bold;color:#0d3b66;">${priceDisplay}</td>
                        <td><button class="btn-edit" onclick="startEdit('${grade}', ${index})">Edit</button> <button class="btn-delete" onclick="deleteItem('${grade}', ${index})">Hapus</button></td>`;
                    tbody.appendChild(tr);
                });
            } else { currentData[grade] = []; }
        }

        function processForm() {
            const grade = document.getElementById('admin-grade').value;
            const name = document.getElementById('new-name').value.trim();
            const price = parseFloat(document.getElementById('new-price').value || 0);
            const required = document.getElementById('new-required').value === 'true';
            const note = document.getElementById('new-note').value.trim();
            const allowReservation = document.getElementById('new-allow-reservation').checked;
            const isBookSet = document.getElementById('is-book-set').checked;
            const isVariantSet = document.getElementById('is-variant-set').checked;

            if (!name) return alert("Sila isi nama item.");
            if (!currentData[grade]) currentData[grade] = [];

            const newItem = {
                name, price, required, note, allowReservation,
                bookList: isBookSet ? [...tempBookList] : [],
                variants: isVariantSet ? [...tempVariantList] : []
            };

            if (editMode && editIndex !== null) {
                currentData[grade][editIndex] = newItem;
                alert("Dikemaskini.");
                cancelEdit();
            } else {
                currentData[grade].push(newItem);
                cancelEdit(); // Reset form
            }
            renderAdminList();
        }

        function startEdit(grade, index) {
            const item = currentData[grade][index];
            document.getElementById('new-name').value = item.name;
            document.getElementById('new-price').value = item.price;
            document.getElementById('new-required').value = item.required.toString();
            document.getElementById('new-note').value = item.note || '';
            document.getElementById('new-allow-reservation').checked = item.allowReservation || false;

            document.getElementById('is-book-set').checked = !!(item.bookList && item.bookList.length);
            tempBookList = item.bookList ? [...item.bookList] : [];
            
            document.getElementById('is-variant-set').checked = !!(item.variants && item.variants.length);
            tempVariantList = item.variants ? [...item.variants] : [];

            toggleSections();
            renderTempBooks();
            renderTempVariants();

            editMode = true;
            editIndex = index;
            document.getElementById('btn-submit').innerText = "‚úì Simpan Kemaskini";
            document.getElementById('btn-submit').className = "btn-update";
            document.getElementById('btn-cancel').style.display = "block";
            document.getElementById('form-title').innerText = "2. Kemaskini Item:";
            document.querySelector('.control-panel').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editMode = false;
            editIndex = null;
            document.getElementById('new-name').value = '';
            document.getElementById('new-price').value = '';
            document.getElementById('new-note').value = '';
            document.getElementById('new-allow-reservation').checked = false;
            document.getElementById('is-book-set').checked = false;
            document.getElementById('is-variant-set').checked = false;
            tempBookList = [];
            tempVariantList = [];
            toggleSections();
            renderTempBooks();
            renderTempVariants();

            document.getElementById('btn-submit').innerText = "+ Tambah Item Ke Jadual";
            document.getElementById('btn-submit').className = "btn-add";
            document.getElementById('btn-cancel').style.display = "none";
            document.getElementById('form-title').innerText = "2. Item Utama:";
        }

        function deleteItem(grade, index) {
            if (confirm("Hapus?")) {
                currentData[grade].splice(index, 1);
                if (editMode && editIndex === index) cancelEdit();
                renderAdminList();
            }
        }

        function saveToStorage() {
            localStorage.setItem('schoolFeesData', JSON.stringify(currentData));
            alert("‚úÖ Disimpan!");
        }

        window.onload = init;
    </script>
</body>
</html>
