<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semakan Yuran SK Pulau Melayu Miri</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary-color: #0d3b66; --bg-color: #f0fdf4; --text-color: #1f2937; --card-bg: #ffffff; --btn-action: #2563eb; --btn-success: #16a34a; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
        
        #capture-area { background-color: var(--bg-color); padding-bottom: 20px; }
        
        .container { max-width: 600px; margin: 0 auto 100px; }
        
        header { text-align: center; margin-bottom: 30px; color: var(--primary-color); }
        .school-logo { height: 120px; width: auto; margin-bottom: 15px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.6rem; font-weight: 700; }
        
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .info-card { background-color: #e3f2fd; border: 1px solid #bbdefb; }
        .doc-card { background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; }
        
        .info-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; font-size: 0.95rem; }
        .doc-list { padding-left: 25px; margin: 0; }
        .doc-list li { margin-bottom: 5px; }
        
        select, input[type="text"] { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; margin-top: 5px; background-color: #fff; box-sizing: border-box; }
        
        .fee-list { list-style: none; padding: 0; margin: 0; }
        .fee-item { padding: 15px 0; border-bottom: 1px solid #f3f4f6; }
        .fee-item-inner { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .checkbox-container { display: flex; align-items: flex-start; cursor: pointer; flex-grow: 1; padding-right: 10px; }
        
        input[type="checkbox"] { width: 20px; height: 20px; margin-right: 12px; margin-top: 2px; accent-color: var(--primary-color); flex-shrink: 0; }
        
        .item-content { display: flex; flex-direction: column; width: 100%; }
        .item-name { font-weight: 600; color: #333; }
        .item-note { font-size: 0.85rem; color: #666; margin-top: 2px; font-style: italic; }
        .item-price { font-weight: bold; color: var(--primary-color); min-width: 90px; text-align: right; font-size: 1rem; }
        
        .tag-wajib { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; vertical-align: middle;}
        .tag-pilihan { background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; vertical-align: middle;}
        
        .total-footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 20px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; z-index: 100; }
        .static-total-display { display: none; margin-top: 20px; padding-top: 15px; border-top: 2px dashed #ccc; text-align: right; font-size: 1.2rem; color: var(--primary-color); font-weight: bold; }
        .total-value { font-size: 1.6rem; font-weight: 800; color: var(--primary-color); }
        
        .disclaimer-box { margin-top: 25px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; color: #6c757d; font-size: 0.85rem; text-align: justify; line-height: 1.4; }
        
        /* Butang Actions */
        .action-buttons { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .btn-export { display: block; width: 100%; background-color: #0d3b66; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; text-align: center; }
        .btn-export:hover { background-color: #0a2e52; }

        .btn-submit { display: block; width: 100%; background-color: var(--btn-success); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; text-align: center; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-submit:hover { background-color: #15803d; }
        .btn-submit:disabled { background-color: #86efac; cursor: not-allowed; }
        
        .hidden { display: none; }
        
        /* Style untuk sub-list buku di page ibu bapa */
        .sub-book-list {
            margin-top: 5px;
            padding-left: 0;
            list-style: none;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #444;
            border-left: 3px solid #2196F3;
        }
        .sub-book-list li { margin-bottom: 3px; display: flex; align-items: center; }
        .sub-book-list li::before { content: "üìò"; margin-right: 6px; font-size: 0.8rem; }

        /* Butang Khas 'Beli di Kaunter' */
        .btn-counter-opt {
            background-color: white;
            border: 1px solid var(--btn-action);
            color: var(--btn-action);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-counter-opt:hover { background-color: #eff6ff; }
        .btn-counter-opt.selected { background-color: var(--btn-action); color: white; border-color: var(--btn-action); }

        /* Style untuk Kotak Nama Tempahan */
        .order-name-box {
            margin-top: 25px;
            padding: 20px;
            background-color: #f0f9ff; /* Biru muda cair */
            border: 2px dashed #0284c7;
            border-radius: 10px;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="capture-area">
        <header>
            <img src="https://i.ibb.co/JR8ksjgY/photo-2025-09-24-10-34-27.jpg" alt="Logo SK Pulau Melayu Miri" class="school-logo">
            <h1>SK Pulau Melayu Miri</h1>
            <p>Rumusan Bayaran Pendaftaran 2026</p>
        </header>

        <div class="container">
            <div class="card info-card">
                <h3 style="margin:0 0 15px 0; font-size:1.1rem; color:var(--primary-color); border-bottom:1px solid #bbdefb; padding-bottom:10px;">Maklumat Hari Pendaftaran</h3>
                <div class="info-row"><div class="info-icon">üìÖ</div><div><strong>Tarikh:</strong> 10 Januari 2026 (Sabtu)</div></div>
                <div class="info-row"><div class="info-icon">‚è∞</div><div><strong>Masa:</strong> 8.00 pagi - 10.00 pagi</div></div>
                <div class="info-row"><div class="info-icon">üìç</div><div><strong>Lokasi:</strong> Di kelas anak masing-masing</div></div>
            </div>

            <div class="card doc-card">
                <h3 style="margin:0 0 15px 0; font-size:1.1rem; border-bottom:1px solid #ffeeba; padding-bottom:10px;">üìÇ Dokumen Penting Perlu Dibawa</h3>
                <ul class="doc-list">
                    <li>Sijil Lahir Anak (Asal & Salinan)</li>
                    <li>Salinan MyKid Anak</li>
                    <li>Salinan Kad Pengenalan Ibu & Bapa</li>
                    <li>Salinan Slip Gaji Ibu & Bapa (Terkini)</li>
                </ul>
            </div>

            <div class="card">
                <label><strong>Pilih Kelas Anak:</strong></label>
                <select id="grade-select" onchange="loadData()">
                    <option value="" disabled selected>-- Sila Pilih Kelas --</option>
                    <option value="pra">Pra Sekolah</option>
                    <option value="1_azam">1 Azam</option>
                    <option value="2_amal">2 Amal</option>
                    <option value="3_tekun">3 Tekun</option>
                    <option value="4_cekal">4 Cekal</option>
                    <option value="5_gigih">5 Gigih</option>
                    <option value="6_yakin">6 Yakin</option>
                </select>
            </div>

            <div id="fee-section" class="card hidden">
                <div style="margin-bottom:15px; font-weight:600; color:var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px;">
                    Senarai Bayaran (<span id="fee-category-display"></span>)
                </div>
                <ul class="fee-list" id="fee-list"></ul>

                <div id="static-total" class="static-total-display">JUMLAH: <span id="static-total-value">RM 0.00</span></div>
                
                <div class="disclaimer-box">
                    <strong>‚ö†Ô∏è Pemakluman:</strong><br>
                    Semua maklumat ini disediakan untuk anggaran keperluan sesi 2026. Tertakluk kepada perubahan. Bayaran rasmi dibuat di kaunter sekolah.
                </div>

                <!-- BORANG TEMPAHAN (Muncul hanya jika item tempahan dipilih) -->
                <div id="reservation-section" class="order-name-box hidden">
                    <h4 style="margin-top:0; color:#0369a1; border-bottom:1px solid #bae6fd; padding-bottom:10px;">üìã Borang Tempahan Awal</h4>
                    
                    <label style="display:block; color:#0369a1; font-weight:bold; margin-bottom:5px;">Nama Penuh Murid:</label>
                    <input type="text" id="student-name" placeholder="TAIP NAMA PENUH DI SINI" oninput="this.value = this.value.toUpperCase()" style="font-weight:bold; color:#0d3b66; border: 2px solid #0284c7;">
                    <small style="display:block; color:#0284c7; margin-top:5px; margin-bottom:15px;">* Wajib isi untuk rekod tempahan buku/alatan di sekolah.</small>

                    <button onclick="submitOrder()" class="btn-submit" id="btn-submit-order">
                        <span>üì§</span> Hantar Tempahan Ke Sekolah
                    </button>
                </div>

                <div class="action-buttons">
                    <button onclick="captureScreenshot()" class="btn-export" id="btn-export-img">
                        üì∏ Simpan Senarai Semak (Gambar)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="total-footer" id="footer-total" style="display:none;">
        <div><div class="total-label">Anggaran Jumlah Perlu Dibayar:</div><div class="total-value" id="grand-total">RM 0.00</div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDrH9ySCZcWvn7GukRHk20-ig4SZpMvFk0", authDomain: "skpm2026-f308b.firebaseapp.com", projectId: "skpm2026-f308b", storageBucket: "skpm2026-f308b.firebasestorage.app", messagingSenderId: "806366483472", appId: "1:806366483472:web:94f5f73c071f50c58be695" };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        signInAnonymously(auth).catch((error) => {
            console.error("Error signing in anonymously:", error);
        });

        const commonFees = [
            { 
                name: "Sumbangan PIBG", 
                price: 30.00, 
                required: true, 
                note: "Satu keluarga sahaja. Dana ini penting untuk membiayai program kecemerlangan akademik, aktiviti sukan, serta penyelenggaraan fasiliti demi keselesaan murid.",
                allowReservation: false 
            },
            { 
                name: "Sumbangan Keceriaan Kelas", 
                price: 10.00, 
                required: true, 
                note: "Setiap murid. Digunakan untuk pembelian alas meja, bahan hiasan papan kenyataan, dan mewujudkan suasana pembelajaran yang ceria dan kondusif.",
                allowReservation: false
            },
            { name: "Baju T-Sekolah (Lengan Pendek)", price: 35.00, required: false, note: "Pilihan / Jika perlu (Kaunter PIBG)", allowReservation: false },
            { name: "Baju T-Sekolah (Lengan Panjang)", price: 40.00, required: false, note: "Pilihan / Jika perlu (Kaunter PIBG)", allowReservation: false },
            { name: "Name Tag (1 set 3 keping)", price: 5.00, required: false, note: "Pilihan (Anggaran Harga)", allowReservation: false },
            { 
                name: "Buku & Alat Tulis", 
                price: 0.00, 
                required: false, 
                note: "Ada jualan dari kedai luar pada hari pendaftaran",
                allowReservation: true // Flag untuk butang tempahan
            }
        ];

        const defaultData = {
            "pra": JSON.parse(JSON.stringify(commonFees)),
            "tahap1": JSON.parse(JSON.stringify(commonFees)),
            "tahap2": JSON.parse(JSON.stringify(commonFees))
        };

        function getSchoolData() {
            const stored = localStorage.getItem('schoolFeesData');
            return stored ? JSON.parse(stored) : defaultData;
        }

        function getFeeCategory(val) {
             if(val === 'pra') return 'pra';
             if(['1_azam','2_amal','3_tekun'].includes(val)) return 'tahap1';
             if(['4_cekal','5_gigih','6_yakin'].includes(val)) return 'tahap2';
             // Fallback
             if(val === 'tahap1') return 'tahap1';
             if(val === 'tahap2') return 'tahap2';
             return 'tahap1';
        }

        // Fungsi Global untuk akses dari HTML onclick
        window.toggleBookCheck = function(btn) {
            const li = btn.closest('.fee-item');
            const checkbox = li.querySelector('input[type="checkbox"]');
            
            checkbox.checked = !checkbox.checked;
            
            if(checkbox.checked) {
                btn.classList.add('selected');
                btn.innerHTML = "‚úÖ Akan dibeli di kaunter sekolah";
            } else {
                btn.classList.remove('selected');
                btn.innerHTML = "üõçÔ∏è Saya nak beli di kaunter sekolah nanti";
            }
            
            window.calculateTotal();
        }

        window.loadData = function() {
            const selectedClass = document.getElementById('grade-select').value;
            const listContainer = document.getElementById('fee-list');
            const feeSection = document.getElementById('fee-section');
            const footer = document.getElementById('footer-total');
            const categoryDisplay = document.getElementById('fee-category-display');
            
            const data = getSchoolData();
            listContainer.innerHTML = '';
            
            if (!selectedClass) {
                feeSection.classList.add('hidden');
                footer.style.display = 'none';
                return;
            }

            const feeCategory = getFeeCategory(selectedClass);
            feeSection.classList.remove('hidden');
            footer.style.display = 'flex';
            
            // Nama paparan kategori
            let catName = 'Tahap 1';
            if(feeCategory === 'pra') catName = 'Prasekolah';
            else if(feeCategory === 'tahap2') catName = 'Tahap 2';
            categoryDisplay.innerText = catName;

            const items = data[feeCategory] || [];

            items.sort((a, b) => (a.required === b.required) ? 0 : a.required ? -1 : 1);

            items.forEach((item) => {
                const li = document.createElement('li');
                li.className = 'fee-item';
                
                const tag = item.required ? `<span class="tag-wajib">WAJIB</span>` : `<span class="tag-pilihan">PILIHAN</span>`;
                const defaultCheckState = item.required ? 'checked' : ''; 
                const displayPrice = item.price === 0 ? "Ikut Belian" : `RM ${item.price.toFixed(2)}`;
                
                let extraHtml = item.note ? `<span class="item-note">${item.note}</span>` : '';

                if (item.bookList && item.bookList.length > 0) {
                    extraHtml += `<ul class="sub-book-list">`;
                    item.bookList.forEach(b => {
                        extraHtml += `<li>${b.name} (${b.qty} unit, ${b.pages}ms)</li>`;
                    });
                    extraHtml += `</ul>`;
                }

                // Periksa flag allowReservation dari data
                const isReservable = item.allowReservation === true;
                let buttonHtml = '';
                
                if (isReservable) {
                    const btnClass = item.required ? 'btn-counter-opt selected' : 'btn-counter-opt';
                    const btnText = item.required ? '‚úÖ Akan dibeli di kaunter sekolah' : 'üõçÔ∏è Saya nak beli di kaunter sekolah nanti';
                    buttonHtml = `<button class="${btnClass}" onclick="toggleBookCheck(this)">${btnText}</button>`;
                }

                li.innerHTML = `
                    <div class="fee-item-inner">
                        <label class="checkbox-container">
                            <input type="checkbox" value="${item.price}" ${defaultCheckState} onchange="calculateTotal()">
                            <div class="item-content">
                                <span class="item-name">${item.name} ${tag}</span>
                                ${extraHtml}
                                ${buttonHtml}
                            </div>
                        </label>
                        <div class="item-price">${displayPrice}</div>
                    </div>
                `;
                listContainer.appendChild(li);
            });

            window.calculateTotal();
        }

        window.calculateTotal = function() {
            let total = 0;
            let isOrderActive = false; 

            document.querySelectorAll('input[type="checkbox"]').forEach(box => {
                if (box.checked) {
                    total += parseFloat(box.value);
                }
                
                const btn = box.closest('.fee-item').querySelector('.btn-counter-opt');
                if(btn) {
                    if(box.checked) {
                        btn.classList.add('selected');
                        btn.innerText = "‚úÖ Akan dibeli di kaunter sekolah";
                        isOrderActive = true;
                    } else {
                        btn.classList.remove('selected');
                        btn.innerText = "üõçÔ∏è Saya nak beli di kaunter sekolah nanti";
                    }
                }
            });

            // Toggle paparan Borang Tempahan
            const reservationSection = document.getElementById('reservation-section');
            if(reservationSection) {
                if(isOrderActive) {
                    reservationSection.classList.remove('hidden');
                } else {
                    reservationSection.classList.add('hidden');
                }
            }

            const fmt = "RM " + total.toFixed(2);
            document.getElementById('grand-total').innerText = fmt;
            document.getElementById('static-total-value').innerText = fmt;
        }

        window.submitOrder = async function() {
            const studentName = document.getElementById('student-name').value.trim();
            const studentClassElem = document.getElementById('grade-select');
            const studentClass = studentClassElem.options[studentClassElem.selectedIndex].text;
            
            // Kumpul Item yang DITEMPAH sahaja (yang ada button aktif)
            const orderItems = [];
            let totalAmount = 0;

            document.querySelectorAll('input[type="checkbox"]').forEach(box => {
                if (box.checked) {
                    // Check jika item ini adalah item tempahan (ada butang kaunter)
                    const btn = box.closest('.fee-item').querySelector('.btn-counter-opt');
                    if(btn && btn.classList.contains('selected')) {
                        const li = box.closest('.fee-item');
                        const itemName = li.querySelector('.item-name').innerText.replace('WAJIB', '').replace('PILIHAN', '').trim();
                        const price = parseFloat(box.value);
                        
                        orderItems.push({ item: itemName, price: price });
                        totalAmount += price;
                    }
                }
            });

            if (orderItems.length === 0) {
                alert("Tiada item tempahan dipilih. Sila klik butang 'Beli di kaunter' pada item buku/alatan.");
                return;
            }

            if (!studentName) {
                alert("Sila masukkan Nama Penuh Murid sebelum menghantar tempahan.");
                document.getElementById('student-name').focus();
                return;
            }

            const submitBtn = document.getElementById('btn-submit-order');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = "‚è≥ Sedang Hantar...";
            submitBtn.disabled = true;

            try {
                const appIdStr = typeof __app_id !== 'undefined' ? __app_id : 'skpm-default';

                await addDoc(collection(db, 'artifacts', appIdStr, 'public', 'data', 'tempahan_2026'), {
                    nama_murid: studentName,
                    kelas: studentClass,
                    senarai_item: orderItems,
                    jumlah_bayaran: totalAmount,
                    tarikh_tempahan: new Date().toISOString()
                });

                alert("‚úÖ Tempahan berjaya dihantar ke sekolah! Sila simpan gambar sebagai rujukan anda.");
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Maaf, terdapat ralat semasa menghantar. Sila pastikan talian internet stabil.");
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        window.captureScreenshot = function() {
            const captureElement = document.getElementById('capture-area');
            const exportBtn = document.getElementById('btn-export-img');
            const reservationSection = document.getElementById('reservation-section');
            const submitBtn = document.getElementById('btn-submit-order');
            const staticTotal = document.getElementById('static-total');
            
            // Sembunyikan butang submit untuk screenshot, tapi kekalkan nama murid
            if(submitBtn) submitBtn.style.display = 'none';
            exportBtn.style.display = 'none';
            staticTotal.style.display = 'block';
            
            html2canvas(captureElement, { useCORS: true, scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'tempahan-yuran-skpm-2026.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                exportBtn.style.display = 'block';
                if(submitBtn) submitBtn.style.display = 'flex'; // Kembalikan display flex
                staticTotal.style.display = 'none';
            }).catch(err => {
                console.error(err);
                alert("Gagal mengambil gambar.");
                exportBtn.style.display = 'block';
                if(submitBtn) submitBtn.style.display = 'flex';
                staticTotal.style.display = 'none';
            });
        }
    </script>
</body>
</html>
